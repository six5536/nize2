import { describe, it, expect, beforeEach, afterEach } from "vitest";
import { render, screen, fireEvent } from "@testing-library/react";
import { DevPanelProvider } from "@/components/dev-panel/dev-panel-provider";
import { useDevPanel } from "@/lib/dev-panel-context";
import { DEV_PANEL_STORAGE_KEY } from "@/lib/types";
import { TabBar } from "@/components/dev-panel/tab-bar";
import { RawChatTab } from "@/components/dev-panel/tabs/raw-chat-tab";

// Test component to access context
function TestConsumer() {
  const { isExpanded, setIsExpanded } = useDevPanel();
  return (
    <div>
      <div data-testid="expanded-state">{isExpanded ? "expanded" : "collapsed"}</div>
      <button onClick={() => setIsExpanded(true)}>Expand</button>
      <button onClick={() => setIsExpanded(false)}>Collapse</button>
    </div>
  );
}

describe("DevPanel", () => {
  beforeEach(() => {
    localStorage.clear();
  });

  afterEach(() => {
    localStorage.clear();
  });

  // @zen-test: DEV_P-2
  // @zen-test: DEV_P-3
  describe("localStorage persistence", () => {
    it("loads expanded state from localStorage on mount", () => {
      localStorage.setItem(DEV_PANEL_STORAGE_KEY, JSON.stringify({ isExpanded: true }));

      render(
        <DevPanelProvider>
          <TestConsumer />
        </DevPanelProvider>
      );

      expect(screen.getByTestId("expanded-state")).toHaveTextContent("expanded");
    });

    it("persists expanded state to localStorage on change", () => {
      render(
        <DevPanelProvider>
          <TestConsumer />
        </DevPanelProvider>
      );

      fireEvent.click(screen.getByText("Expand"));

      const stored = localStorage.getItem(DEV_PANEL_STORAGE_KEY);
      expect(stored).toBeDefined();
      const state = JSON.parse(stored!);
      expect(state.isExpanded).toBe(true);
    });

    it("persists collapsed state to localStorage", () => {
      localStorage.setItem(DEV_PANEL_STORAGE_KEY, JSON.stringify({ isExpanded: true }));

      render(
        <DevPanelProvider>
          <TestConsumer />
        </DevPanelProvider>
      );

      fireEvent.click(screen.getByText("Collapse"));

      const stored = localStorage.getItem(DEV_PANEL_STORAGE_KEY);
      expect(stored).toBeDefined();
      const state = JSON.parse(stored!);
      expect(state.isExpanded).toBe(false);
    });

    it("handles corrupted localStorage gracefully", () => {
      localStorage.setItem(DEV_PANEL_STORAGE_KEY, "invalid json");

      render(
        <DevPanelProvider>
          <TestConsumer />
        </DevPanelProvider>
      );

      expect(screen.getByTestId("expanded-state")).toHaveTextContent("collapsed");
    });
  });

  // @zen-test: DEV-1.1_AC-2
  describe("tab selection", () => {
    it("calls onTabChange when tab is clicked", () => {
      let selectedTab = "tab1";
      const tabs = [
        { id: "tab1", label: "Tab 1" },
        { id: "tab2", label: "Tab 2" },
      ];

      const { rerender } = render(
        <TabBar tabs={tabs} activeTab={selectedTab} onTabChange={(tab) => (selectedTab = tab)} />
      );

      fireEvent.click(screen.getByText("Tab 2"));

      rerender(<TabBar tabs={tabs} activeTab={selectedTab} onTabChange={(tab) => (selectedTab = tab)} />);

      expect(selectedTab).toBe("tab2");
    });

    it("highlights active tab", () => {
      const tabs = [
        { id: "tab1", label: "Tab 1" },
        { id: "tab2", label: "Tab 2" },
      ];

      render(<TabBar tabs={tabs} activeTab="tab1" onTabChange={() => {}} />);

      const tab1 = screen.getByText("Tab 1");
      const tab2 = screen.getByText("Tab 2");

      expect(tab1.className).toContain("text-blue-400");
      expect(tab2.className).toContain("text-gray-400");
    });
  });

  // @zen-test: DEV-2_AC-4
  describe("text truncation", () => {
    it("truncates long text content in messages", () => {
      const longText = "a".repeat(300);
      const chatState = {
        messages: [{ role: "user", content: longText }],
        isLoading: false,
        error: null,
        input: "",
      };

      render(<DevPanelProvider><RawChatTab chatState={chatState} /></DevPanelProvider>);

      const jsonDisplay = screen.getByRole("code");
      expect(jsonDisplay.textContent).not.toContain(longText);
      expect(jsonDisplay.textContent).toContain("...");
    });

    it("shows empty state when no chat active", () => {
      render(<DevPanelProvider><RawChatTab chatState={null} /></DevPanelProvider>);

      expect(screen.getByText("No active chat")).toBeInTheDocument();
    });
  });

  // @zen-test: DEV_P-1
  describe("production bundle exclusion", () => {
    it("verifies dev panel components are tree-shakeable", () => {
      // This test verifies the architectural decision to use dynamic imports
      // In production, the DevPanel should not render and components should be tree-shaken
      const originalEnv = process.env.NODE_ENV;
      process.env.NODE_ENV = "production";

      render(
        <DevPanelProvider>
          <div>App Content</div>
        </DevPanelProvider>
      );

      // In production, only app content should render
      expect(screen.getByText("App Content")).toBeInTheDocument();
      expect(screen.queryByText("Dev Panel")).not.toBeInTheDocument();

      process.env.NODE_ENV = originalEnv;
    });
  });

  // @zen-test: DEV_P-3
  describe("layout independence", () => {
    it("does not affect main content layout when collapsed", () => {
      const { container } = render(
        <DevPanelProvider>
          <div data-testid="main-content" style={{ width: "100%" }}>
            Main Content
          </div>
        </DevPanelProvider>
      );

      const mainContent = container.querySelector('[data-testid="main-content"]');
      expect(mainContent).toBeInTheDocument();

      // Main content should occupy full width regardless of dev panel state
      const computedStyle = window.getComputedStyle(mainContent!);
      expect(computedStyle.width).toBeTruthy();
    });
  });
});
