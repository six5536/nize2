# .github/workflows/release.yml
# This workflow will build, test, generate release notes using Claude, then publish a new release to NPM
# Uses composite actions for modular, reusable components
# Contains crates.io publishing (disabled — enable via PUBLISH_CRATES_IO repository variable)

name: Release

on:
  workflow_dispatch:

permissions:
  contents: write
  id-token: write # Required for OIDC to NPM
  pull-requests: read
  repository-projects: write # Required for updating GitHub Projects status

jobs:
  branch-guard:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
    steps:
      - name: Ensure release runs on main
        run: |
          if [ "${GITHUB_REF}" != "refs/heads/main" ]; then
            echo "::error::Release workflow can only run from main (got ${GITHUB_REF})"
            exit 1
          fi

  release:
    runs-on: ubuntu-latest
    needs: branch-guard
    defaults:
      run:
        shell: bash

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: "1.93.0"
          targets: wasm32-unknown-unknown
          components: rustfmt, clippy

      - name: Cache Cargo registry, target & wasm-pack
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            ~/.cargo/bin/wasm-pack
            target
          key: release-${{ runner.os }}-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: release-${{ runner.os }}-

      - uses: actions/setup-node@v4
        with:
          node-version: "24.x"
          registry-url: "https://registry.npmjs.org"
          cache: "npm"

      - name: Install npm dependencies
        run: npm ci
        working-directory: packages/nize-cli

      - name: Install wasm-pack
        run: command -v wasm-pack || cargo install wasm-pack

      # ── Version validation ──────────────────────────────────────────────────
      - name: Get version from package.json
        id: pkg
        run: |
          VERSION=$(node -p "require('./packages/nize-cli/package.json').version")
          if ! [[ "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.]+)?$ ]]; then
            echo "::error::Invalid version format: $VERSION (expected X.X.X or X.X.X-prerelease)"
            exit 1
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=v$VERSION" >> $GITHUB_OUTPUT

      - name: Verify Cargo.toml version matches
        run: |
          CARGO_VERSION=$(grep -m1 '^version' Cargo.toml | sed 's/.*"\(.*\)".*/\1/')
          NPM_VERSION="${{ steps.pkg.outputs.version }}"
          # Strip pre-release suffix for comparison (Cargo.toml uses base version)
          NPM_BASE="${NPM_VERSION%%-*}"
          if [ "$CARGO_VERSION" != "$NPM_BASE" ] && [ "$CARGO_VERSION" != "$NPM_VERSION" ]; then
            echo "::error::Version mismatch: Cargo.toml=$CARGO_VERSION, package.json=$NPM_VERSION"
            exit 1
          fi

      - name: Check if tag already exists
        run: |
          if git rev-parse "v${{ steps.pkg.outputs.version }}" >/dev/null 2>&1; then
            echo "::error::Tag v${{ steps.pkg.outputs.version }} already exists!"
            exit 1
          fi

      - name: Get previous tag and date
        id: prev_tag
        env:
          CURRENT_VERSION: ${{ steps.pkg.outputs.version }}
        run: |
          PREV_TAG=$(git tag -l "v[0-9]*.[0-9]*.[0-9]*" --sort=-v:refname | head -n 1)
          echo "tag=$PREV_TAG" >> $GITHUB_OUTPUT

          if [ -n "$PREV_TAG" ]; then
            PREV_DATE=$(git log -1 --format=%aI "$PREV_TAG")
            echo "date=$PREV_DATE" >> $GITHUB_OUTPUT

            # Version comparison check
            CLEAN_PREV=${PREV_TAG#v}
            HIGHEST=$(printf "%s\n%s" "$CURRENT_VERSION" "$CLEAN_PREV" | sort -V | tail -n 1)

            if [ "$CURRENT_VERSION" != "$HIGHEST" ] || [ "$CURRENT_VERSION" == "$CLEAN_PREV" ]; then
               echo "::error::New version $CURRENT_VERSION must be greater than previous version $CLEAN_PREV"
               exit 1
            fi
          fi

      # ── Rust checks ───────────────────────────────────────────────
      - name: cargo test --workspace
        run: cargo test --workspace

      - name: cargo clippy
        run: cargo clippy --workspace -- -D warnings

      - name: cargo fmt --check
        run: cargo fmt --all -- --check

      # ── Build ─────────────────────────────────────────────────────
      - name: Build WASM + TypeScript
        run: npm run build
        working-directory: packages/nize-cli

      # ── Test ──────────────────────────────────────────────────────────
      - name: Build Rust CLI (for cross-validation)
        run: cargo build --bin nize-cli

      - name: Run tests
        run: npm test
        working-directory: packages/nize-cli

      # ── Release data & notes ──────────────────────────────────────
      # Composite action: Collect PR and commit data
      - name: Collect release data
        id: release_data
        uses: ./.github/actions/collect-release-data
        with:
          previous-tag: ${{ steps.prev_tag.outputs.tag }}
          previous-date: ${{ steps.prev_tag.outputs.date }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      # Composite action: Generate release notes with Claude
      - name: Generate release notes
        id: claude
        uses: ./.github/actions/generate-release-notes
        with:
          anthropic-api-key: ${{ secrets.ANTHROPIC_API_KEY }}
          tag-name: ${{ steps.pkg.outputs.tag }}
          previous-tag: ${{ steps.prev_tag.outputs.tag }}
          pr-list: ${{ steps.release_data.outputs.pr-list }}
          issue-list: ${{ steps.release_data.outputs.issue-list }}
          commit-log: ${{ steps.release_data.outputs.commit-log }}
          repository-url: "https://github.com/${{ github.repository }}"
          contributors: ${{ steps.release_data.outputs.contributors }}

      # Upload debug artifacts on failure
      - name: Upload Claude API artifacts for debugging
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: claude-api-debug
          path: |
            payload.json
            response.json
          retention-days: 7

      # ── Publish NPM ──────────────────────────────────────────────
      - name: Publish to NPM
        run: npm publish --access public
        working-directory: packages/nize-cli
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      # ── Publish crates.io (disabled) ──────────────────────────────
      # Enable by setting repository variable PUBLISH_CRATES_IO=true
      # Publish order: dependencies first
      - name: Publish nize-core to crates.io
        if: ${{ vars.PUBLISH_CRATES_IO == 'true' }}
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
        run: cargo publish -p nize-core

      - name: Publish nize-mcp to crates.io
        if: ${{ vars.PUBLISH_CRATES_IO == 'true' }}
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
        run: cargo publish -p nize-mcp

      # ── GitHub Release ────────────────────────────────────────────
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.pkg.outputs.tag }}
          name: ${{ steps.pkg.outputs.tag }}
          body: ${{ steps.claude.outputs.notes }}
          draft: false

      # ── Post-release ──────────────────────────────────────────────
      # Composite action: Comment on PRs and issues
      - name: Comment on PRs and Issues
        continue-on-error: true
        uses: ./.github/actions/comment-on-release
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          tag-name: ${{ steps.pkg.outputs.tag }}
          pr-urls: ${{ steps.release_data.outputs.pr-urls }}
          linked-issue-urls: ${{ steps.release_data.outputs.linked-issue-urls }}
          commit-issue-urls: ${{ steps.release_data.outputs.commit-issue-urls }}

      # Composite action: Update issue status in GitHub Projects
      - name: Update issue status in project
        continue-on-error: true
        uses: ./.github/actions/update-project-status
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          org-name: six5536
          project-number: "1"
          target-status: "Done"
          linked-issue-urls: ${{ steps.release_data.outputs.linked-issue-urls }}
          commit-issue-urls: ${{ steps.release_data.outputs.commit-issue-urls }}
